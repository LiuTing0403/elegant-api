!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.elegantApi=t():e.elegantApi=t()}(this,function(){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={exports:{},id:n,loaded:!1};return e[n].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,t,r){"use strict";var n=r(1),o=r(2);e.exports=function(e,t){var r=new o(e,t),a={};return n.objectKeys(r.routes).forEach(function(e){a[e]=function(){for(var t=arguments.length,n=Array(t),o=0;t>o;o++)n[o]=arguments[o];return r.request.apply(r,[e].concat(n))}}),a.$ea=r,a.$request=function(){return r.request.apply(r,arguments)},a.$r=a.$resource=function(e){var t=r.resources[e];return t?Object.keys(t).reduce(function(e,r){var n=t[r].defaultValue;return e[r]=void 0===n?null:n,e},{}):{}},a.$cache=function(e){var t=e||r.globals,n=t.cacheMap,o=t.cacheStack;return e?void(n&&o&&(r.globals.cacheMap=n,r.globals.cacheStack=o)):{cacheMap:n,cacheStack:o}},a},e.exports.ElegantApi=o},function(e,t){"use strict";function r(){}function n(e){return e?Object.keys(e):[]}function o(e){return Object.prototype.toString.call(e)}function a(e){return"[object Object]"===o(e)}function i(e){return Array.isArray(e)}function u(e){return a(e)?e:{}}function c(e,t){if(i(e))for(var r=0;r<e.length;r++)t(e[r],r,e);else a(e)&&n(e).forEach(function(r){return t(e[r],r,e)})}function s(e,t){return n(e).reduce(function(r,n){return r[n]=t(e[n],n,e),r},{})}function f(e){var t=void 0;if(a(e))t={};else{if(!Array.isArray(e))return e;t=[]}return c(e,function(e,r){return t[r]=f(e)}),t}function l(e,t){return t=[].concat(t),Object.keys(e).reduce(function(r,n){return t.indexOf(n)<0&&(r[n]=e[n]),r},{})}function p(){var e=!1,t=[].slice.call(arguments);"boolean"==typeof t[0]&&(e=t.shift());for(var r=t.shift()||{},n=void 0,u=0;u<t.length;u++)n=t[u],(a(n)||i(n))&&(o(r)!==o(n)?r=f(n):c(n,function(t,n){e&&(a(t)||i(t))?r[n]=p(e,r[n],t):r[n]=t}));return r}function d(e){var t=[];return t.add=function(e,t){null==t&&(t=""),this.push(encodeURIComponent(e)+"="+encodeURIComponent(t))},h(t,e),t.join("&")}function h(e,t,r){var n=i(t),o=a(t),u=void 0;c(t,function(t,c){u=a(t)||i(t),r&&(c=r+"["+(o||u?c:"")+"]"),!r&&n?e.add(t.name,t.value):u?h(e,t,c):e.add(c,t)})}function m(e){return e.replace(/(?:[^:])\/\//g,"/")}function y(e,t){if(""===t)return e;var r=e.split("#");return(r[0]+"&"+t).replace(/[&?]{1,2}/,"?")+(2===r.length?"#"+r[1]:"")}t.__esModule=!0,t.emptyFunction=r,t.objectKeys=n,t.toString=o,t.isObject=a,t.isArray=i,t.objectify=u,t.each=c,t.mapObject=s,t.deepClone=f,t.omit=l,t.extend=p,t.buildQuery=d,t.urlNormalize=m,t.appendQuery=y,t.isServer="undefined"==typeof window},function(e,t,r){"use strict";function n(e){return e&&e.__esModule?e:{"default":e}}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e){}function i(e,t,r){for(var n in e){var o=r?r+"."+n:n;m.isObject(e[n])?i(e[n],t,o):t(o,e[n])}}function u(e,t){var r=[e];return t?(t.split(".").forEach(function(e){var t=[];r.forEach(function(r){r&&("[]"===e&&Array.isArray(r)?t=t.concat(r):t.push(r[e]))}),r=t}),r.filter(function(e){return e})):r}function c(e,t,r){i(m.objectify(t),function(t,n){var o=t.split("."),a=o.pop();t=o.join("."),u(e,t).forEach(function(e){return r(e,t,a,n)})})}var s=r(6),f=n(s),l=r(4),p=n(l),d=r(5),h=r(3),m=r(1),y=r(7),v=void 0;try{localStorage.setItem("_ea","_ea"),localStorage.removeItem("_ea"),v=localStorage}catch(g){v={}}e.exports=function(){function e(t,r){var n=this;o(this,e);var i=m.extend(!0,{},p["default"],t),u=i,c=u.globals,s=u.routes,f=u.resources,l=u.mocks;delete i.globals,delete i.routes,delete i.resources,delete i.mocks,i=(0,h.formatRootOptions)(i),this.globals=c,this.mocks=r||l,m.each(this.mocks,function(e,t){t in s&&"$default"!==t||(s[t]={})}),(0,d.mixin)(this.mocks),this.routes=m.mapObject(s,function(e,t){return(0,h.formatInitialRoute)(t,m.objectify(e),i)}),this.resources=m.mapObject(f,h.formatResource),this.responseResources=m.mapObject(this.resources,h.reverseResource),this.apis={},this._needReloadRouteNameMap={},m.each(this.routes,function(e){return n.apis[e.name]=n._generateApi(e)}),a(!0,"You are using a debug version of elegant-api, you can switch to production version by using elegant-api.min.js")}return e.prototype._apply=function(e,t,r){var n=this,o=t.order||["resource","alias","computed","drop","map","naming"];return o.forEach(function(o){var a="_apply"+o.charAt(0).toUpperCase()+o.slice(1);a in n&&(e=n[a](e,t[o],r))}),e},e.prototype._applyResource=function(e,t,r){var n=this;return t?(m.objectKeys(t).reduce(function(o,a){var i=n.resources[a],c=[].concat(t[a]);if(!i)throw new Error("Resource "+a+" not exists.");return c.forEach(function(t){u(e,t).forEach(function(e){m.isObject(e)&&n["_"+r+"Resource"](e,i,a)})}),o},{}),e):e},e.prototype._requestResource=function(e,t){var r=[];m.each(t,function(t,n){var o=e[n],a=n;t.alias&&t.alias!==n&&(r.push(n),a=t.alias),void 0===o&&(o=t.defaultValue),e[a]=t.write?t.write.call(e,o):o}),m.each(r,function(t){return delete e[t]})},e.prototype._responseResource=function(e,t,r){t=this.responseResources[r],this._requestResource(e,t)},e.prototype._applyAlias=function(e,t){return c(e,t,function(e,t,r,n){if("string"!=typeof n)throw new SyntaxError("Expect string value for alias.");r in e&&(e[n]=e[r],delete e[r])}),e},e.prototype._applyComputed=function(e,t){return c(e,t,function(t,r,n,o){if("function"!=typeof o)throw new SyntaxError("Expect function value for computed.");t[n]=o.call(t,t,e)}),e},e.prototype._applyDrop=function(e,t){var r;return"string"==typeof t?(r={},r[t]=!0,t=r):m.isArray(t)&&(t=t.reduce(function(e,t){return e[t]=!0,e},{})),m.isObject(t)&&c(e,t,function(e,t,r){r in e&&delete e[r]}),e},e.prototype._applyMap=function(e,t){return"function"==typeof t?t(e):e},e.prototype._applyNaming=function(e,t){return"string"==typeof t&&(t={"case":t}),m.isObject(t)?(t.naming=t["case"],(0,f["default"])(e,t)):e},e.prototype._cache=function(e,t){var r=this,n=this._getCache(e);return n.exists?(t(null,n.value),!1):function(n,o){n||r._setCache(e,o),t(n,o)}},e.prototype.removeCache=function(e){var t=this;if(!e)return!1;var r=this.globals,n=r.cacheMap,o=r.cacheStack,a=[].concat(e);a.forEach(function(e){t._needReloadRouteNameMap[e]=!0,delete n[e]}),this.globals.cacheStack=o.filter(function(e){return a.indexOf(e[0])<0})},e.prototype._getCache=function(e){var t=this.globals.cacheMap,r=e.name,n=e.http,o=void 0,i=!1,u=null,c=void 0;if(r in t){t=t[r],o=JSON.stringify([n.params,n.query]),i=o in t,c=t[o]||{};var s=c.expire;0!==s&&s<+new Date?i=!1:u=c.value}return a(e.mock.debug,"EA:(cache) check %s %o, %sexists!",r,{key:o,keys:m.objectKeys(t)},i?"":"not "),{exists:i,value:u}},e.prototype._setCache=function(e,t){var r=this.globals,n=r.cacheSize,o=r.cacheMap,i=r.cacheStack,u=e.name,c=e.http,s=o[u]||{},f=JSON.stringify([c.params,m.omit(c.query,["__ea","__eaData"])]);a(e.mock.debug,"EA:(cache) set %s %o",u,{key:f,cacheMap:o});var l=1e3*e.cache.expireSeconds;if(l>0&&(l+=+new Date),s[f]={value:t,expire:l},o[u]=s,i.push([u,f]),n>0&&i.length>n){var p=i.shift(),d=p[0],h=p[1];o[d]&&delete o[d][h]}},e.prototype._transform=function(e,t){var r=this,n=e.http;return n.data=this._apply(n.data,e.request,"request"),function(n,o){if(n)return t(n,o);try{o=r._apply(m.deepClone(o),e.response,"response"),r.removeCache(e.removeCache),t(n,o)}catch(n){t(n)}}},e.prototype._emulate=function(e){var t=e.mock,r=e.http,n=e.name,o=m.buildQuery(r.query);r.url=m.appendQuery(r.path,o),(!e.cache.enable||this._needReloadRouteNameMap[n])&&(r.url=m.appendQuery(r.url,this.globals.cacheQueryKey+"="+(new Date).getTime()),delete this._needReloadRouteNameMap[n]),t.server&&!/^https?:\/\//.test(r.url)&&(r.crossOrigin=!0,r.url=m.urlNormalize(("self"===t.server?"":t.server)+r.url)),e.emulateHTTP&&!r.crossOrigin&&/^(PUT|PATCH|DELETE)$/.test(r.method)&&(r.headers["X-HTTP-Method-Override"]=r.method,r.method="POST"),e.emulateJSON&&(r.headers["Content-Type"]="application/x-www-form-urlencoded",r.data=m.buildQuery(r.data))},e.prototype._generateApi=function(e){var t=this;return function(r,n,o){var i=void 0;try{i=(0,h.formatRealtimeRoute)(e,r,n)}catch(u){return o(u)}var c=i,s=c.mock,f=c.http,l=c.dataTransformMethod;if(o=t._transform(i,o),i.cache.enable&&(o=t._cache(i,o),o===!1))return!1;f.body=f.data=(0,h.decodeUserData)(f.data);var p=t._generateApiTransformData(i);if(!s.disabled&&!s.memory)if(p=JSON.stringify(p),f.query.__ea=i.name,s.server&&"self"!==s.server||"cookie"!==l||m.isServer)f.query.__eaData=p;else{var d=new Date;d.setTime(d.getTime()+5e3);var y="__ea"+i.name+"="+encodeURIComponent(p)+"; expires="+d.toUTCString()+"; path=/";a(s.debug,"EA:(request) write cookie %o",y),document.cookie=y}t._emulate(i),t._response(i,p,o)}},e.prototype._response=function(e,t,r){var n=this,o=e.mock,i=e.http;a(o.debug,"EA:(response) route: %o, transformData %o",e,t);var u=function(){y(n.mocks,e.name,t,function(t,n){e.handle({http:i,error:t,data:n},r)})};o.memory?0===o.delay?u():setTimeout(u,o.delay):e.handle({http:i},r)},e.prototype._generateApiTransformData=function(e){var t=v.__ea?JSON.parse(v.__ea):{},r=this.globals.eaQueryPrefix,n=e.http,o="";return m.isServer||(o=location.search.slice(1)),o.split("&").reduce(function(e,t){var n=t.split("=").map(decodeURIComponent),o=n[0],a=n[1];return o!==r&&0===o.indexOf(r)&&(e[o.substr(r.length)]=a),e},t),v.__ea=JSON.stringify(t),{mock:e.mock,params:n.params,query:n.query,data:n.data,ea:t}},e.prototype.request=function(e,t,r,n){var o=this;"function"==typeof t?n=t:"function"==typeof r&&(n=r),t=m.objectify(t),r=m.objectify(r),"function"!=typeof n&&(n=m.emptyFunction);var a=function(n){return"string"==typeof e?o._singleRequest(e,t,r,n):m.isArray(e)?o._batchSeriesRequest(e,t,r,n):m.isObject(e)?o._batchParallelRequest(e,t,r,n):void n(new SyntaxError("Illegal arguments."))};return"undefined"!=typeof Promise?new Promise(function(e,t){a(function(r,o){r?t(r):e(o),n(r,o)})}):void a(n)},e.prototype._singleRequest=function(e,t,r,n){return this.apis[e]?this.apis[e](t,r,n):void n(new Error("Request key '"+e+"' not exists."))},e.prototype._batchSeriesRequest=function(e,t,r,n){var o=this,a=0,i=null,u=null,c=t.iterator||m.emptyFunction,s=void 0,f=function l(){var t=e[a++];if(t){if(s=c(t,a-1,i,u),s===!1)return n(i,u);o.request(t,s,r[t],function(e,t){i=e,u=t,l()})}else n(i,u)};f()},e.prototype._batchParallelRequest=function(e,t,r,n){var o=this,a=Object.keys(e),i=a.length,u=new Error("MAP_ERROR"),c={},s=!1,f=t.iterator||m.emptyFunction;a.forEach(function(a){var l=e[a],p=t.alias&&t.alias[a]||a;o.request(p,l,r[p],function(e,t){i--,f(l,a,e,t),e?(s=!0,u[a]=e,e.message&&(u.message=e.message)):c[a]=t,i||n(s?u:null,c)})})},e}()},function(e,t,r){"use strict";function n(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function o(e){return _.isObject(e)?e:"string"!=typeof e?{}:e.split("&").reduce(function(e,t){var r=t.split("=").map(decodeURIComponent),n=r[0],o=r[1],a={},i=void 0;return o&&":"===o[0]&&o[1]?i=o.slice(1):o&&(a.value=o),(""===o||i)&&(a.required=!0),i&&(a.alias=n,n=i),e[n]=a,e},{})}function a(e){var t=e.http;for(var r in t)r in e&&(t[r]=e[r]);return t.path=_.urlNormalize(e.base+e.path),t.method=t.method.toUpperCase(),e.http}function i(e){var t=e.mock;return _.isObject(t)||(t=e.mock={disabled:!t}),"debug"in t||(t.debug=e.debug),t.disabled&&delete t.memory,(t.disabled||t.memory)&&(delete t.server,delete t.proxy),e.mock}function u(e){var t=e.cache,r=void 0,n=0;return _.isObject(t)?(r=t.enable,n=t.expireSeconds||0):r=t,r="smart"===r&&k.indexOf(e.http.method)>=0||r===!0,0>n&&(r=!1),e.cache={enable:r,expireSeconds:n},e.cache}function c(e){return e.query=o(e.query),e.data=o(e.data),e}function s(e,t,r){return t.name||(t.name=e),t.query=o(t.query),t.data=o(t.data),t=_.extend(!0,{},r,t),a(t),i(t),u(t),t}function f(e){var t=[];return e.replace(/\/:([-\w]+)/g,function(e,r){t.push(r)}),t}function l(e,t){return e.replace(/\/:([-\w]+)/g,function(e,r){return"/"+t[r]})}function p(e){return _.isObject(e)&&(e=_.extend({min:200,max:3e3},e),e=Math.floor(Math.random()*(e.max-e.min)+e.min)),e=parseInt(e,10),e&&e>0?e:0}function d(e,t){e=_.extend(!0,{},e);var r=_.objectKeys(e),n=t.http,o=["params","query","data"],a=j.indexOf(n.method)>=0;if(r.every(function(e){return o.indexOf(e)>=0}))return"data"in e&&(e.data=m(e.data)),o.forEach(function(t){return e[t]=_.objectify(e[t])}),a&&(e.data={}),h(e,t);var i=_.objectKeys(t.query),u=f(n.path),c={},s={},l={},p=t.query,d=t.data;return r.forEach(function(t){u.indexOf(t)>=0?c[t]=e[t]:i.indexOf(t)>=0?s[p[t]&&p[t].alias||t]=e[t]:a||(l[d[t]&&d[t].alias||t]=e[t])}),h({params:c,query:s,data:l},t)}function h(e,t){var r=t.http.path,n=f(r),o=t.name;return n.forEach(function(t){if(!(t in e.params))throw new SyntaxError("Route "+o+" missing params parameter: "+t+".")}),["query","data"].forEach(function(r){var n=e[r],a=t[r];_.each(a,function(e,t){var a=e.alias||t,i=n[a],u=a in n;if(e.required&&!u)throw new SyntaxError("Route "+o+" missing "+r+" parameter: "+t+".");if(e.validate&&u&&("function"==typeof e.validate&&!e.validate(i)||e.validate instanceof RegExp&&!e.validate.test(i)))throw new SyntaxError("Route "+o+" "+r+" parameter '"+a+"' validate error.");"value"in e&&!u&&(n[a]=e.value)})}),e}function m(e){var t;return _.isObject(e)?e:(t={},t[E]=e,t)}function y(e){return E in e?e[E]:e}function v(e,t,r){e=_.extend(!0,{},e),r=_.extend(!0,{},r);var n=e.http,o=r.http||{};o.path&&(o.path=_.urlNormalize(e.base+o.path)),o.method&&(o.method=o.method.toUpperCase()),_.extend(!0,n,o),"mock"in r&&(e.mock=i(r)),"cache"in r&&(e.cache=u(r)),"debug"in r&&(e.mock.debug=r.debug);var a=d(t,e),c=a.params,s=a.query,f=a.data;return _.each(s,function(e,t,r){return r[t]=String(e)}),n.path=l(n.path,c),n.params=c,n.query=s,n.data=f,e.mock.delay=e.mock.memory?p(e.mock.delay):0,e}function g(e,t){return _.objectKeys(e).reduce(function(r,o){var a=e[o],i="undefined"==typeof a?"undefined":n(a),u=void 0,c=void 0,s=void 0,f=void 0,l=void 0;"string"===i?c=a:"function"===i?u=a:a&&(u=a.type,c=a.alias,s=a.defaultValue,f=a.read,l=a.write);var p=x.indexOf(u);if(p>=0)"undefined"==typeof s&&(s=w[p]);else{if(u)throw new Error("Not supported resource type for "+t+"."+o);u=null}return r[o]={type:u,alias:c,defaultValue:s,read:f,write:l},r},{})}function b(e,t){var r={};return _.each(e,function(e,t){var n=e.type,o=e.alias,a=e.defaultValue,i=e.read,u=e.write;if(o){var c=[o,t];t=c[0],o=c[1]}var s=[u,i];i=s[0],u=s[1],r[t]={type:n,alias:o,defaultValue:a,read:i,write:u}}),r}t.__esModule=!0,t.formatRootOptions=c,t.formatInitialRoute=s,t.encodeUserData=m,t.decodeUserData=y,t.formatRealtimeRoute=v,t.formatResource=g,t.reverseResource=b;var _=r(1),x=[Number,String,Boolean],w=[0,"",!1],k=["GET","HEAD"],j=["GET","HEAD"],E="__raw_data_v1"},function(e,t){"use strict";t.__esModule=!0,t["default"]={debug:!1,base:"",path:"",emulateJSON:!1,emulateHTTP:!1,cache:"smart",mock:{memory:!0,server:null,proxy:null,delay:{min:200,max:1e3}},dataTransformMethod:"query",globals:{eaQueryPrefix:"__",cacheQueryKey:"_t",cacheSize:100,cacheMap:{},cacheStack:[]},http:{method:"GET",crossOrigin:!1,credentials:"same-origin",dataType:"json",data:null,headers:{}},request:{naming:null},response:{naming:{"case":"camel",deep:0}},handle:function(e,t){if(this.mock.memory)return t(e.error,e.data);var r=window.jQuery&&window.jQuery.ajax;if(r)return r(e.http).success(function(e){return t(null,e)}).error(function(e){return t(e)});throw new Error("Need implement handler function in options")},mocks:{},resources:{},routes:{}}},function(e,t,r){"use strict";function n(e){e.$objectify=function(t,r){return o(e,r,t,!0)},e.$objectifyAll=function(t,r){return Promise.all([].concat(r).map(function(r){return e.$objectify(t,r)}))},e.$fetch=function(t,r,n){return n&&n.body&&(n.data=n.body,delete n.body),o(e,r,(0,a.extend)({},t,n))},e.$fetchAll=function(t,r){var n=(0,a.objectKeys)(r);return Promise.all(n.map(function(n){return e.$fetch(t,n,r[n])})).then(function(e){return Promise.resolve(n.reduce(function(t,r,n){return t[r]=e[n],t},{}))})}}function o(e,t,r,n){return new Promise(function(o,a){return"function"!=typeof e[t]?o(e[t]):void e[t](r,function(r,i){r?a(r):(n&&(e[t]=i),o(i))})})}t.__esModule=!0,t.mixin=n;var a=r(1)},function(e,t){"use strict";function r(e,t){return e.match(c).reduce(t,"")}function n(e,t,r){var a=e;if(u(e)){a={};for(var c in e)e.hasOwnProperty(c)&&(a[o(c,r,t,e)]=1===t?e[c]:n(e[c],t>1?t-1:t,r))}else if(i(e)){a=[];for(var s=0;s<e.length;s++)a.push(n(e[s],t,r))}return a}function o(e,t,r,n){if("string"==typeof t&&t in s)return s[t](e);if("function"==typeof t){var o=t(e,r,n);if(!o)return e;if("string"==typeof o)return o;throw new Error("Transform naming function should return a valid string value!")}throw new Error("Not supported transform naming type, only support `string` and `function`")}function a(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function i(e){return"array"===a(e)}function u(e){return"object"===a(e)}t.__esModule=!0,t["default"]=function(e){var t=arguments.length<=1||void 0===arguments[1]?{}:arguments[1],r=t.deep,a=void 0===r?0:r,i=t.naming,u=void 0===i?"camel":i;return"string"==typeof e?o(e,u,a,null):n(e,a,u)};var c=function(){var e="[A-Z\\xc0-\\xd6\\xd8-\\xde]",t="[a-z\\xdf-\\xf6\\xf8-\\xff]+";return RegExp(e+"+(?="+e+t+")|"+e+"?"+t+"|"+e+"+|[0-9]+","g")}(),s={camel:function(e){return r(e,function(e,t,r){var n=r?"toUpperCase":"toLowerCase";return e+t.charAt(0)[n]()+t.slice(1)})},cap:function(e){return r(e,function(e,t,r){return e+t.charAt(0).toUpperCase()+t.slice(1)})},kebab:function(e){return r(e,function(e,t,r){return e+(r?"-":"")+t.toLowerCase()})},snake:function(e){return r(e,function(e,t,r){return e+(r?"_":"")+t.toLowerCase()})}},f=s.camel,l=s.cap,p=s.kebab,d=s.snake;t.camel=f,t.cap=l,t.kebab=p,t.snake=d},function(e,t){e.exports=function(e,t,r,n){var o;t in e||"$default"in e?(o=t in e?e[t]:e.$default,r.mock.name=t,"function"==typeof o?o.call(e,r,n):n(null,o)):n({message:"Not found mock target for `"+t+"`.",name:"ConfigError",by:"ElegantApi"})}}])});